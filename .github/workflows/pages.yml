name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      OPENSCAD_SNAPSHOT_VERSION: 2026.01.19
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: true

      - name: Generate params
        run: |
          set -euo pipefail

          sudo apt-get update
          sudo apt-get install -y just xvfb libegl1 libgl1 libopengl0 curl

          # Ubuntu's OpenSCAD is too old; use a nightly snapshot AppImage.
          version="$OPENSCAD_SNAPSHOT_VERSION"
          base='https://files.openscad.org/snapshots'
          appimage="OpenSCAD-${version}-x86_64.AppImage"
          cache_dir="$GITHUB_WORKSPACE/.openscad-cache"

          mkdir -p "$cache_dir"
          cd "$cache_dir"
          if [ ! -f "$appimage" ]; then
            curl -fsSLo "$appimage" "$base/$appimage"
          fi
          chmod +x "$appimage"
          if [ ! -d squashfs-root ]; then
            "./$appimage" --appimage-extract >/dev/null
          fi

          cat > openscad <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          exec xvfb-run -a "$DIR/squashfs-root/AppRun" "$@"
          EOF
          chmod +x openscad

          echo "$cache_dir" >> "$GITHUB_PATH"
          export PATH="$cache_dir:$PATH"
          cd "$GITHUB_WORKSPACE"

          just params

      - name: Generate site
        uses: yawkat/web-openscad-editor@main
        with:
          scad-json: |
            [
              {"file": "coin-cells.scad", "additional-params": ["build/configurable-bin-params.json"]},
              {"file": "cylindrical-cells.scad", "additional-params": ["build/configurable-bin-params.json"]}
            ]
          mode: multi
          output: out

      - name: Publish
        uses: cloudflare/wrangler-action@v3
        id: cf_publish
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: >-
            pages deploy out/
            --project-name=binkat-yawk-at
            --branch=main
      - name: Check PR
        uses: 8BitJonny/gh-get-current-pr@4.0.0
        id: pr
      - name: Comment on PR
        if: steps.pr.outputs.pr_found == 'true'
        uses: thollander/actions-comment-pull-request@v3
        with:
          comment-tag: deployment
          message: ":rocket: Preview deployed to ${{ steps.cf_publish.outputs.deployment-url }}"
          pr-number: "${{steps.pr.outputs.number}}"
